{% extends 'base.html' %}
{% load static %}

{% block title %}{{ event.title }} - EVENT VIBE{% endblock %}

{% block content %}
<div class="container mt-3 sm:mt-5 mb-3 sm:mb-5 px-3 sm:px-4">
    <div class="row">
        <div class="col-12 col-md-8 mb-4 md:mb-0">
            <div class="glass-card fade-in-up">
                {% if event.flyer %}
                    <div style="position: relative; overflow: hidden; border-radius: 15px; margin-bottom: 1.5rem;">
                        <img src="{{ event.flyer.url }}" class="event-card-image" alt="{{ event.title }}" 
                             style="width: 100%; height: 250px; object-fit: cover; border-radius: 15px;">
                        <div class="badge-vibrant" style="position: absolute; top: 20px; right: 20px; background: linear-gradient(135deg, var(--blue-primary) 0%, var(--cyan-bright) 100%);">
                            <i class="bi bi-fire"></i> Hot Event
                        </div>
                    </div>
                {% endif %}
                
                <h1 class="text-gradient mb-3 sm:mb-4" style="font-size: 1.75rem; font-weight: 900;">
                    {{ event.title }}
                </h1>
                
                <div class="mb-4">
                    <p class="event-card-date mb-3" style="font-size: 1.1rem;">
                        <i class="bi bi-calendar3-fill"></i> 
                        <strong>{{ event.event_date|date:"d F Y" }}</strong>
                    </p>
                    <p class="mb-3" style="color: var(--cyan-bright); font-size: 1.1rem;">
                        <i class="bi bi-clock-fill"></i> 
                        <strong>{{ event.event_time|time:"H:i" }} WIB</strong>
                    </p>
                    <p class="event-card-location mb-3" style="font-size: 1.1rem;">
                        <i class="bi bi-geo-alt-fill"></i> 
                        <strong>
                            {% if event.location_type == 'online' %}
                                Online (Zoom Meeting)
                            {% elif event.location_type == 'hybrid' %}
                                Hybrid: {{ event.location }} + Zoom Meeting
                            {% else %}
                                {{ event.location }}
                            {% endif %}
                        </strong>
                    </p>
                    {% if event.zoom_link %}
                        {% if user.is_authenticated and is_registered %}
                            {% if event.price and event.price > 0 %}
                                {% if registration and registration.payment_status == 'approved' %}
                                    <div class="alert alert-info mb-3" style="background-color: #DBEAFE; border: 1px solid #3B82F6; border-radius: 10px; color: #1E40AF;">
                                        <h6 class="mb-2" style="font-weight: 700;">
                                            <i class="bi bi-camera-video me-2"></i> Informasi Zoom Meeting
                                        </h6>
                                        <p class="mb-2">
                                            <strong>Link:</strong> 
                                            <a href="{{ event.zoom_link }}" target="_blank" style="color: #1E40AF; text-decoration: underline; font-weight: 600;">
                                                Klik untuk bergabung
                                            </a>
                                        </p>
                                        {% if event.zoom_meeting_id %}
                                            <p class="mb-1"><strong>Meeting ID:</strong> {{ event.zoom_meeting_id }}</p>
                                        {% endif %}
                                        {% if event.zoom_passcode %}
                                            <p class="mb-0"><strong>Passcode:</strong> {{ event.zoom_passcode }}</p>
                                        {% endif %}
                                    </div>
                                {% else %}
                                    <div class="alert alert-warning mb-3" style="background-color: #FEF3C7; border: 1px solid #F59E0B; border-radius: 10px; color: #92400E;">
                                        <h6 class="mb-2" style="font-weight: 700;">
                                            <i class="bi bi-lock-fill me-2"></i> Link Zoom Meeting
                                        </h6>
                                        <p class="mb-0">
                                            Link Zoom Meeting akan tersedia setelah pembayaran Anda disetujui oleh Event Organizer.
                                        </p>
                                    </div>
                                {% endif %}
                            {% else %}
                                <div class="alert alert-info mb-3" style="background-color: #DBEAFE; border: 1px solid #3B82F6; border-radius: 10px; color: #1E40AF;">
                                    <h6 class="mb-2" style="font-weight: 700;">
                                        <i class="bi bi-camera-video me-2"></i> Informasi Zoom Meeting
                                    </h6>
                                    <p class="mb-2">
                                        <strong>Link:</strong> 
                                        <a href="{{ event.zoom_link }}" target="_blank" style="color: #1E40AF; text-decoration: underline; font-weight: 600;">
                                            Klik untuk bergabung
                                        </a>
                                    </p>
                                    {% if event.zoom_meeting_id %}
                                        <p class="mb-1"><strong>Meeting ID:</strong> {{ event.zoom_meeting_id }}</p>
                                    {% endif %}
                                    {% if event.zoom_passcode %}
                                        <p class="mb-0"><strong>Passcode:</strong> {{ event.zoom_passcode }}</p>
                                    {% endif %}
                                </div>
                            {% endif %}
                        {% else %}
                            <div class="alert alert-warning mb-3" style="background-color: #FEF3C7; border: 1px solid #F59E0B; border-radius: 10px; color: #92400E;">
                                <h6 class="mb-2" style="font-weight: 700;">
                                    <i class="bi bi-lock-fill me-2"></i> Link Zoom Meeting
                                </h6>
                                <p class="mb-0">
                                    {% if user.is_authenticated %}
                                        Daftar terlebih dahulu untuk mengakses link Zoom Meeting.
                                    {% else %}
                                        Login dan daftar terlebih dahulu untuk mengakses link Zoom Meeting.
                                    {% endif %}
                                </p>
                            </div>
                        {% endif %}
                    {% endif %}
                </div>
                
                <hr style="border-color: rgba(255,255,255,0.1); margin: 2rem 0;">
                
                <h4 class="text-gradient mb-3" style="font-weight: 700;">
                    <i class="bi bi-info-circle"></i> Deskripsi Event
                </h4>
                <p class="text-white-50" style="line-height: 1.8; font-size: 1.05rem;">
                    {{ event.description|linebreaks }}
                </p>
                
                <hr style="border-color: rgba(255,255,255,0.1); margin: 2rem 0;">
                
                <h4 class="text-gradient mb-3" style="font-weight: 700;">
                    <i class="bi bi-person-badge"></i> Event Organizer
                </h4>
                <div class="alert" style="background: linear-gradient(135deg, #DBEAFE 0%, #E0E7FF 100%); border: 2px solid #3B82F6; border-radius: 15px; padding: 1.5rem;">
                    <p class="mb-2" style="font-size: 1.1rem; color: #1F2937; font-weight: 600;">
                        <i class="bi bi-person-fill" style="color: #1E3A8A;"></i> <strong style="color: #1F2937;">{{ event.user.name }}</strong>
                    </p>
                    <p class="mb-1" style="font-size: 1rem; color: #1F2937;">
                        <i class="bi bi-envelope-fill" style="color: #1E3A8A;"></i> 
                        <a href="mailto:{{ event.user.email }}" style="color: #1E40AF; text-decoration: none; font-weight: 500;">
                            {{ event.user.email }}
                        </a>
                    </p>
                    <p class="mb-0" style="font-size: 1rem; color: #1F2937;">
                        <i class="bi bi-telephone-fill" style="color: #1E3A8A;"></i> 
                        <a href="tel:{{ event.user.phone }}" style="color: #1E40AF; text-decoration: none; font-weight: 500;">
                            {{ event.user.phone }}
                        </a>
                    </p>
                    <p class="mt-3 mb-0 small" style="color: #4B5563; font-weight: 500; background-color: rgba(255,255,255,0.7); padding: 0.75rem; border-radius: 8px; border-left: 4px solid #3B82F6;">
                        <i class="bi bi-info-circle" style="color: #1E3A8A;"></i> Hubungi Event Organizer jika ada pertanyaan tentang event ini atau jika token Anda hilang.
                    </p>
                </div>
            </div>
        </div>
        
        <div class="col-12 col-md-4">
            <div class="glass-card fade-in-up" style="animation-delay: 0.2s; position: relative; top: 0;">
                <h5 class="text-gradient mb-4" style="font-weight: 700;">
                    <i class="bi bi-lightning-charge-fill"></i> Join Now
                </h5>
                
                {% if event.is_registration_open %}
                    <div class="alert mb-3" style="background: rgba(59, 130, 246, 0.2); border: 2px solid var(--blue-primary); border-radius: 15px; color: #fff;">
                        <i class="bi bi-check-circle-fill"></i> <strong>Pendaftaran Masih Dibuka!</strong>
                    </div>
                {% else %}
                    <div class="alert mb-3" style="background: rgba(37, 99, 235, 0.2); border: 2px solid var(--blue-dark); border-radius: 15px; color: #fff;">
                        <i class="bi bi-x-circle-fill"></i> <strong>Pendaftaran Sudah Ditutup</strong>
                    </div>
                {% endif %}
                
                {% if user.is_authenticated %}
                    {% if is_registered %}
                        <div class="alert mb-3" style="background: rgba(59, 130, 246, 0.2); border: 2px solid var(--blue-primary); border-radius: 15px; color: #fff;">
                            <i class="bi bi-check-circle-fill"></i> <strong>Anda sudah terdaftar!</strong>
                        </div>
                        
                        <!-- Payment Status & Upload Form -->
                        {% if event.price and event.price > 0 %}
                            {% if registration.payment_status == 'approved' %}
                                <div class="alert alert-success mb-3" style="background-color: #D1FAE5; border: 1px solid #10B981; border-radius: 10px; color: #065F46;">
                                    <i class="bi bi-check-circle-fill"></i> <strong>Pembayaran Disetujui</strong>
                                    <p class="mb-1 mt-2 small">Pembayaran Anda telah divalidasi. Anda dapat mengikuti acara ini.</p>
                                    {% if registration.payment_validated_by %}
                                        <p class="mb-0 small"><strong>Divalidasi oleh:</strong> {{ registration.payment_validated_by.name }}</p>
                                    {% endif %}
                                    {% if registration.payment_validated_at %}
                                        <p class="mb-0 small"><strong>Tanggal validasi:</strong> {{ registration.payment_validated_at|date:"d M Y H:i" }}</p>
                                    {% endif %}
                                </div>
                            {% elif registration.payment_status == 'rejected' %}
                                <div class="alert alert-danger mb-3" style="background-color: #FEE2E2; border: 1px solid #EF4444; border-radius: 10px; color: #991B1B;">
                                    <i class="bi bi-x-circle-fill"></i> <strong>Pembayaran Ditolak</strong>
                                    {% if registration.payment_rejection_reason %}
                                        <p class="mb-1 mt-2 small"><strong>Alasan:</strong> {{ registration.payment_rejection_reason }}</p>
                                    {% endif %}
                                    {% if registration.payment_validated_by %}
                                        <p class="mb-0 small"><strong>Ditolak oleh:</strong> {{ registration.payment_validated_by.name }}</p>
                                    {% endif %}
                                    {% if registration.payment_validated_at %}
                                        <p class="mb-0 small"><strong>Tanggal:</strong> {{ registration.payment_validated_at|date:"d M Y H:i" }}</p>
                                    {% endif %}
                                </div>
                                {% if not registration.payment_proof %}
                                    <form method="POST" action="{% url 'registrations:upload_payment' event.id %}" enctype="multipart/form-data" class="mb-3">
                                        {% csrf_token %}
                                        <div class="mb-3">
                                            <label for="{{ payment_form.payment_proof.id_for_label }}" class="form-label" style="font-weight: 600; color: #1F2937 !important;">
                                                <i class="bi bi-upload me-1"></i> Upload Bukti Pembayaran Baru *
                                            </label>
                                            <input type="file" name="payment_proof" id="{{ payment_form.payment_proof.id_for_label }}" class="form-control" accept="image/*,.pdf" required style="background-color: rgba(255,255,255,0.95) !important; color: #1F2937 !important; border: 1px solid rgba(255,255,255,0.5); border-radius: 10px; padding: 0.75rem;">
                                            {% if payment_form.payment_proof.errors %}
                                                <div class="text-danger small mt-1" style="color: #FFD700 !important;">{{ payment_form.payment_proof.errors }}</div>
                                            {% endif %}
                                            <small class="d-block mt-2" style="color: #1F2937 !important;">
                                                <i class="bi bi-info-circle"></i> Format: JPG, PNG, atau PDF (Max 5MB)
                                            </small>
                                        </div>
                                        <button type="submit" class="btn w-100" style="background-color: #1E3A8A !important; color: #FFFFFF !important; font-weight: 700 !important; border-radius: 8px;">
                                            <i class="bi bi-upload me-2" style="color: #FFFFFF !important;"></i> <span style="color: #FFFFFF !important;">Upload Bukti Pembayaran</span>
                                        </button>
                                    </form>
                                {% endif %}
                            {% elif registration.payment_status == 'pending' %}
                                <div class="alert alert-warning mb-3" style="background-color: #FEF3C7; border: 1px solid #F59E0B; border-radius: 10px; color: #92400E;">
                                    <i class="bi bi-clock-history"></i> <strong>Menunggu Validasi Pembayaran</strong>
                                    <p class="mb-0 mt-2 small">Bukti pembayaran Anda sedang ditinjau oleh Event Organizer.</p>
                                </div>
                            {% elif not registration.payment_proof %}
                                <form method="POST" action="{% url 'registrations:upload_payment' event.id %}" enctype="multipart/form-data" class="mb-3">
                                    {% csrf_token %}
                                    <div class="mb-3">
                                        <label for="{{ payment_form.payment_proof.id_for_label }}" class="form-label" style="font-weight: 600; color: #1F2937 !important;">
                                            <i class="bi bi-upload me-1"></i> Upload Bukti Pembayaran *
                                        </label>
                                        <input type="file" name="payment_proof" id="{{ payment_form.payment_proof.id_for_label }}" class="form-control" accept="image/*,.pdf" required style="background-color: rgba(255,255,255,0.95) !important; color: #1F2937 !important; border: 1px solid rgba(255,255,255,0.5); border-radius: 10px; padding: 0.75rem;">
                                        {% if payment_form.payment_proof.errors %}
                                            <div class="text-danger small mt-1" style="color: #FFD700 !important;">{{ payment_form.payment_proof.errors }}</div>
                                        {% endif %}
                                        <small class="d-block mt-2" style="color: #1F2937 !important;">
                                            <i class="bi bi-info-circle"></i> Format: JPG, PNG, atau PDF (Max 5MB)
                                        </small>
                                    </div>
                                    <button type="submit" class="btn w-100" style="background-color: #1E3A8A !important; color: #FFFFFF !important; font-weight: 700 !important; border-radius: 8px;">
                                        <i class="bi bi-upload me-2" style="color: #FFFFFF !important;"></i> <span style="color: #FFFFFF !important;">Upload Bukti Pembayaran</span>
                                    </button>
                                </form>
                            {% endif %}
                        {% endif %}
                        
                        <a href="{% url 'registrations:history' %}" class="btn btn-vibrant w-100" style="color: #FFFFFF !important; font-weight: 700 !important;">
                            <i class="bi bi-clock-history"></i> Lihat Riwayat
                        </a>
                    {% elif event.is_registration_open %}
                        <!-- Payment Info untuk Event Berbayar -->
                        {% if event.price and event.price > 0 %}
                            <div class="alert alert-info mb-3" style="background-color: #DBEAFE; border: 1px solid #3B82F6; border-radius: 10px; color: #1E40AF;">
                                <h6 class="mb-2" style="font-weight: 700;"><i class="bi bi-credit-card me-2"></i> Informasi Pembayaran</h6>
                                <p class="mb-2"><strong>Harga:</strong> Rp {{ event.price|floatformat:0 }}</p>
                                {% if event.bank_name and event.bank_account %}
                                    <p class="mb-0"><strong>Transfer ke:</strong> {{ event.bank_name }} - {{ event.bank_account }}</p>
                                {% endif %}
                                <p class="mb-0 mt-2 small"><i class="bi bi-info-circle"></i> Setelah transfer, upload bukti pembayaran saat mendaftar.</p>
                            </div>
                        {% endif %}
                        
                        <form method="POST" action="{% url 'registrations:register_event' event.id %}" enctype="multipart/form-data">
                            {% csrf_token %}
                            {% if event.price and event.price > 0 %}
                                <div class="mb-3">
                                    <label for="payment_proof" class="form-label" style="font-weight: 600; color: #1F2937 !important;">
                                        <i class="bi bi-upload me-1"></i> Upload Bukti Pembayaran *
                                    </label>
                                    <input type="file" name="payment_proof" id="payment_proof" class="form-control" accept="image/*,.pdf" required style="background-color: rgba(255,255,255,0.95) !important; color: #1F2937 !important; border: 1px solid rgba(255,255,255,0.5); border-radius: 10px; padding: 0.75rem;">
                                    <small class="d-block mt-2" style="color: #1F2937 !important;">
                                        <i class="bi bi-info-circle"></i> Format: JPG, PNG, atau PDF (Max 5MB)
                                    </small>
                                </div>
                            {% endif %}
                            <button type="submit" class="btn btn-vibrant btn-lg w-100 pulse" style="color: #FFFFFF !important; font-weight: 700 !important;">
                                <i class="bi bi-lightning-charge-fill"></i> Daftar Sekarang!
                            </button>
                        </form>
                        <p class="text-white-50 small text-center mt-3">
                            <i class="bi bi-info-circle"></i> Token akan dikirim ke email Anda
                        </p>
                    {% else %}
                        <button class="btn btn-secondary w-100" disabled style="opacity: 0.5;">
                            <i class="bi bi-lock-fill"></i> Pendaftaran Ditutup
                        </button>
                    {% endif %}
                {% else %}
                    <div class="alert mb-3" style="background: rgba(6, 182, 212, 0.2); border: 2px solid var(--blue-neon); border-radius: 15px; color: #fff;">
                        <i class="bi bi-exclamation-triangle-fill"></i> <strong>Login untuk mendaftar</strong>
                    </div>
                    <a href="{% url 'accounts:login' %}" class="btn btn-vibrant w-100" style="color: #FFFFFF !important; font-weight: 700 !important;">
                        <i class="bi bi-box-arrow-in-right"></i> Login
                    </a>
                    <a href="{% url 'accounts:register' %}" class="btn btn-pink w-100 mt-2" style="background: linear-gradient(135deg, #1E3A8A 0%, #3B82F6 100%); color: #FFFFFF !important; font-weight: 700 !important;">
                        <i class="bi bi-person-plus"></i> Daftar Akun
                    </a>
                {% endif %}
                
                <hr style="border-color: rgba(255,255,255,0.1); margin: 2rem 0;">
                
                {% if user.is_authenticated and user.role == 'user' %}
                    {% if not has_reported %}
                        <div class="text-center mb-3">
                            <a href="{% url 'events:report' event.id %}" class="btn w-100" style="background-color: #DC3545 !important; color: #FFFFFF !important; border: 2px solid #DC3545 !important; border-radius: 8px; font-weight: 600; padding: 0.75rem 1rem; text-decoration: none;">
                                <span style="color: #FFFFFF !important;">Laporkan Event</span>
                            </a>
                        </div>
                    {% else %}
                        <div class="alert alert-info mb-3" style="background: rgba(59, 130, 246, 0.2); border: 1px solid var(--blue-primary); border-radius: 10px; color: #fff;">
                            <i class="bi bi-info-circle"></i> Anda sudah melaporkan event ini.
                        </div>
                    {% endif %}
                {% endif %}
                
                <div class="text-center">
                    <a href="{% url 'events:catalog' %}" class="text-gradient" style="text-decoration: none; font-weight: 600;">
                        <i class="bi bi-arrow-left"></i> Kembali ke Katalog
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
